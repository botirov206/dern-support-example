<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Dern-Support</title>
    <link href="/css/output.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-inter">
    <!-- Navigation -->
    <nav class="bg-blue-900 text-white fixed w-full top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="/dashboard" class="flex items-center space-x-2">
                        <i class="fas fa-laptop-medical text-2xl"></i>
                        <span class="font-bold text-xl">Dern-Support</span>
                    </a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/dashboard" class="flex items-center px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-800">
                            <i class="fas fa-chart-line mr-2"></i> Dashboard
                        </a>
                        <a href="/submit-request" class="flex items-center px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-800">
                            <i class="fas fa-paper-plane mr-2"></i> New Request
                        </a>
                        <a href="/dashboard/knowledge-base" class="flex items-center px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-800">
                            <i class="fas fa-book mr-2"></i> Knowledge Base
                        </a>
                        <div class="relative" id="userMenu">
                            <button id="userMenuBtn" class="flex items-center px-3 py-2 rounded-md text-sm font-medium bg-blue-800">
                                <i class="fas fa-user-circle mr-2"></i>
                                <span id="userName">Account</span>
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                                <div class="py-1">
                                    <a href="/account" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-cog mr-2"></i> Settings
                                    </a>
                                    <button id="logoutBtn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="px-6 py-4 bg-blue-900 text-white">
                    <h1 class="text-xl font-semibold">Account Settings</h1>
                    <p class="text-blue-100 text-sm mt-1">Manage your account information and preferences</p>
                </div>

                <div class="p-6">
                    <!-- Profile Information -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Profile Information</h2>
                        <form id="profileForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="profileName" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" name="name" id="profileName" required
                                        class="mt-1 block w-full py-3 px-4 text-base text-gray-900 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p id="profileName-error" class="mt-1 text-xs text-red-600 hidden">Name is required.</p>
                                </div>
                                <div>
                                    <label for="profileEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="profileEmail" disabled
                                        class="mt-1 block w-full py-3 px-4 text-base text-gray-700 border border-gray-300 bg-gray-100 rounded-md shadow-sm cursor-not-allowed sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">Email cannot be changed.</p>
                                </div>
                                <div>
                                    <label for="profileType" class="block text-sm font-medium text-gray-700">Account Type</label>
                                    <input type="text" id="profileType" disabled
                                        class="mt-1 block w-full py-3 px-4 text-base text-gray-700 border border-gray-300 bg-gray-100 rounded-md shadow-sm cursor-not-allowed sm:text-sm">
                                </div>
                                <div>
                                    <label for="profileMemberSince" class="block text-sm font-medium text-gray-700">Member Since</label>
                                    <input type="text" id="profileMemberSince" disabled
                                        class="mt-1 block w-full py-3 px-4 text-base text-gray-700 border border-gray-300 bg-gray-100 rounded-md shadow-sm cursor-not-allowed sm:text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="profileAddress" class="block text-sm font-medium text-gray-700">Address</label>
                                <textarea name="address" id="profileAddress" required rows="3"
                                    class="mt-1 block w-full py-3 px-4 text-base text-gray-900 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                <p id="profileAddress-error" class="mt-1 text-xs text-red-600 hidden">Address is required.</p>
                            </div>
                            <div id="profileUpdateStatus" class="text-sm hidden"></div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="bg-blue-900 text-white py-3 px-4 rounded-md hover:bg-blue-800 flex items-center text-base font-medium">
                                    <i class="fas fa-save mr-2"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Password -->
                    <div class="border-t border-gray-200 pt-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h2>
                        <form id="passwordForm" class="space-y-6">
                            <div>
                                <label for="currentPassword" class="block text-sm font-medium text-gray-700">Current Password</label>
                                <input type="password" name="currentPassword" id="currentPassword" required
                                    class="mt-1 block w-full py-3 px-4 text-base text-gray-900 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <p id="currentPassword-error" class="mt-1 text-xs text-red-600 hidden">Current password is required.</p>
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" name="newPassword" id="newPassword" required minlength="6"
                                    class="mt-1 block w-full py-3 px-4 text-base text-gray-900 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <p class="mt-1 text-xs text-gray-500">Must be at least 6 characters long.</p>
                                <p id="newPassword-error" class="mt-1 text-xs text-red-600 hidden">New password must be at least 6 characters.</p>
                            </div>
                            <div>
                                <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                <input type="password" name="confirmPassword" id="confirmPassword" required
                                    class="mt-1 block w-full py-3 px-4 text-base text-gray-900 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <p id="confirmPassword-error" class="mt-1 text-xs text-red-600 hidden">Passwords do not match or confirmation is missing.</p>
                            </div>
                            <div id="passwordUpdateStatus" class="text-sm hidden"></div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="bg-blue-900 text-white py-3 px-4 rounded-md hover:bg-blue-800 flex items-center text-base font-medium">
                                    <i class="fas fa-key mr-2"></i> Update Password
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Notification Preferences -->
                    <div class="border-t border-gray-200 pt-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Notification Preferences</h2>
                        <form id="notificationForm" class="space-y-4">
                            <div class="space-y-3">
                                <div class="relative flex items-start">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" id="emailUpdates" name="emailUpdates" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="emailUpdates" class="font-medium text-gray-700">Email updates</label>
                                        <p class="text-gray-500 text-xs">Get notified about your support requests via email.</p>
                                    </div>
                                </div>
                                <div class="relative flex items-start">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" id="smsUpdates" name="smsUpdates" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="smsUpdates" class="font-medium text-gray-700">SMS notifications</label>
                                        <p class="text-gray-500 text-xs">Receive SMS for urgent updates (requires phone number).</p>
                                    </div>
                                </div>
                                <div class="relative flex items-start">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" id="newsletter" name="newsletter" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="newsletter" class="font-medium text-gray-700">Monthly Newsletter</label>
                                        <p class="text-gray-500 text-xs">Stay up-to-date with our latest news and offers.</p>
                                    </div>
                                </div>
                            </div>
                            <div id="preferencesUpdateStatus" class="text-sm hidden"></div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="bg-blue-900 text-white py-3 px-4 rounded-md hover:bg-blue-800 flex items-center text-base font-medium">
                                    <i class="fas fa-bell mr-2"></i> Update Preferences
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize protected page and load user data
            if (!initProtectedPage()) {
                return; // Redirects if not authenticated
            }
            const currentUser = getCurrentUser();

            // Helper function to apply input styles (can be moved to main.js)
            function setInputState(inputElement, state, message = '') {
                const errorElement = document.getElementById(inputElement.id + '-error');
                inputElement.classList.remove('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500'); 
                inputElement.classList.remove('border-red-500', 'text-red-900', 'placeholder-red-300', 'focus:border-red-500', 'focus:ring-red-500');
                inputElement.classList.remove('border-green-500', 'text-green-900', 'placeholder-green-300', 'focus:border-green-500', 'focus:ring-green-500');

                if (errorElement) errorElement.classList.add('hidden');

                if (state === 'error') {
                    inputElement.classList.add('border-red-500', 'text-red-900', 'placeholder-red-300', 'focus:border-red-500', 'focus:ring-red-500');
                    if (errorElement && message) {
                        errorElement.textContent = message;
                        errorElement.classList.remove('hidden');
                    }
                } else if (state === 'success') {
                    inputElement.classList.add('border-green-500', 'text-green-900', 'placeholder-green-300', 'focus:border-green-500', 'focus:ring-green-500');
                } else { 
                    inputElement.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
                }
            }
            
            // Add real-time validation listeners to a form
            function addRealTimeValidation(form) {
                form.querySelectorAll('input, select, textarea').forEach(input => {
                    if(input.type === 'checkbox' || input.disabled) return; // Skip checkboxes and disabled fields
                    input.addEventListener('input', () => {
                        if (input.checkValidity()) {
                            setInputState(input, 'success');
                        } else {
                            // Optionally show error on type if you want instant feedback for invalid patterns
                        }
                    });
                    input.addEventListener('invalid', (e) => {
                        setInputState(input, 'error', input.validationMessage);
                    });
                    input.addEventListener('blur', () => { 
                        if (!input.checkValidity() && input.value.trim() !== '') { 
                           setInputState(input, 'error', input.validationMessage);
                        } else if (input.checkValidity() && input.value.trim() !== '') {
                            setInputState(input, 'success');
                        } else if (input.value.trim() === ''){
                            setInputState(input, 'default'); 
                        }
                    });
                });
            }

            // User menu dropdown (can be centralized)
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            if (userMenuBtn && userMenuDropdown) {
                 userMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                userMenuDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                    if (!userMenuBtn.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                    userMenuDropdown.classList.add('hidden');
                }
            });
            }
            
            // Populate Profile Form
            const profileForm = document.getElementById('profileForm');
            const profileNameInput = document.getElementById('profileName');
            const profileEmailInput = document.getElementById('profileEmail');
            const profileTypeInput = document.getElementById('profileType');
            const profileAddressInput = document.getElementById('profileAddress');
            const profileMemberSinceInput = document.getElementById('profileMemberSince');
            const profileUpdateStatus = document.getElementById('profileUpdateStatus');

            if (currentUser) {
                profileNameInput.value = currentUser.name || '';
                profileEmailInput.value = currentUser.email || '';
                profileTypeInput.value = currentUser.accountType ? (currentUser.accountType.charAt(0).toUpperCase() + currentUser.accountType.slice(1)) : '';
                profileAddressInput.value = currentUser.address || '';
                // Fetch full profile for memberSince, as currentUser from localStorage might not have it
                fetchWithAuth('/api/users/profile').then(res => res.json()).then(fullProfile => {
                     profileMemberSinceInput.value = fullProfile.createdAt ? new Date(fullProfile.createdAt).toLocaleDateString() : 'N/A';
                }).catch(err => console.error('Failed to load full profile', err));
            }
            addRealTimeValidation(profileForm);

            profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                profileUpdateStatus.classList.add('hidden');
                profileUpdateStatus.textContent = '';

                let formIsValid = true;
                profileForm.querySelectorAll('input[required], textarea[required]').forEach(input => {
                    if (!input.checkValidity()) {
                        setInputState(input, 'error', input.validationMessage);
                        formIsValid = false;
                        } else {
                        setInputState(input, 'success');
                    }
                });
                if (!formIsValid) return;

                const submitButton = profileForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

                try {
                    const response = await fetchWithAuth('/api/users/profile', {
                        method: 'PUT',
                        body: JSON.stringify({
                            name: profileNameInput.value,
                            address: profileAddressInput.value
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to update profile');
                    
                    profileUpdateStatus.textContent = 'Profile updated successfully!';
                    profileUpdateStatus.className = 'text-sm text-green-600';
                    profileUpdateStatus.classList.remove('hidden');
                    // Update local storage
                    const updatedUser = { ...currentUser, name: data.user.name, address: data.user.address };
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    // Update name in nav immediately
                    document.querySelectorAll('.user-name').forEach(el => el.textContent = data.user.name);

                } catch (error) {
                    profileUpdateStatus.textContent = error.message;
                    profileUpdateStatus.className = 'text-sm text-red-600';
                    profileUpdateStatus.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });

            // Password Change Form
            const passwordForm = document.getElementById('passwordForm');
            const passwordUpdateStatus = document.getElementById('passwordUpdateStatus');
            addRealTimeValidation(passwordForm);

            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                passwordUpdateStatus.classList.add('hidden');
                passwordUpdateStatus.textContent = '';

                let formIsValid = true;
                passwordForm.querySelectorAll('input[required]').forEach(input => {
                     if (!input.checkValidity()) {
                        setInputState(input, 'error', input.validationMessage);
                        formIsValid = false;
                        } else {
                        setInputState(input, 'success');
                    }
                });

                const newPassword = passwordForm.newPassword.value;
                const confirmPassword = passwordForm.confirmPassword.value;
                if (newPassword !== confirmPassword) {
                    setInputState(passwordForm.confirmPassword, 'error', 'Passwords do not match.');
                    formIsValid = false;
                }
                if (!formIsValid) return;

                const submitButton = passwordForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Updating...';

                try {
                    const response = await fetchWithAuth('/api/users/change-password', {
                        method: 'POST',
                        body: JSON.stringify({
                            currentPassword: passwordForm.currentPassword.value,
                            newPassword: newPassword
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || (data.errors ? data.errors[0].msg : 'Failed to update password'));
                    
                    passwordUpdateStatus.textContent = 'Password updated successfully!';
                    passwordUpdateStatus.className = 'text-sm text-green-600';
                    passwordUpdateStatus.classList.remove('hidden');
                    passwordForm.reset();
                    passwordForm.querySelectorAll('input').forEach(input => setInputState(input, 'default'));

                    } catch (error) {
                    passwordUpdateStatus.textContent = error.message;
                    passwordUpdateStatus.className = 'text-sm text-red-600';
                    passwordUpdateStatus.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });

            // Notification Preferences Form
            const notificationForm = document.getElementById('notificationForm');
            const preferencesUpdateStatus = document.getElementById('preferencesUpdateStatus');
            const emailUpdatesCheckbox = document.getElementById('emailUpdates');
            const smsUpdatesCheckbox = document.getElementById('smsUpdates');
            const newsletterCheckbox = document.getElementById('newsletter');
            
            // Load current preferences
             fetchWithAuth('/api/users/profile').then(res => res.json()).then(fullProfile => {
                if (fullProfile && fullProfile.preferences) {
                    emailUpdatesCheckbox.checked = fullProfile.preferences.emailUpdates;
                    smsUpdatesCheckbox.checked = fullProfile.preferences.smsUpdates;
                    newsletterCheckbox.checked = fullProfile.preferences.newsletter;
                }
            }).catch(err => console.error('Failed to load preferences', err));

            notificationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                preferencesUpdateStatus.classList.add('hidden');
                preferencesUpdateStatus.textContent = '';

                const submitButton = notificationForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Updating...';
                
                try {
                    const response = await fetchWithAuth('/api/users/preferences', {
                        method: 'PUT',
                        body: JSON.stringify({
                            emailUpdates: emailUpdatesCheckbox.checked,
                            smsUpdates: smsUpdatesCheckbox.checked,
                            newsletter: newsletterCheckbox.checked
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to update preferences');

                    preferencesUpdateStatus.textContent = 'Preferences updated successfully!';
                    preferencesUpdateStatus.className = 'text-sm text-green-600';
                    preferencesUpdateStatus.classList.remove('hidden');

            } catch (error) {
                    preferencesUpdateStatus.textContent = error.message;
                    preferencesUpdateStatus.className = 'text-sm text-red-600';
                    preferencesUpdateStatus.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });
        });
    </script>
</body>
</html> 